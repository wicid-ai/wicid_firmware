name: Build and Release Firmware

on:
  push:
    tags:
      - 'v[0-9]*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate tag format
        run: |
          TAG="${{ github.ref_name }}"
          if ! echo "$TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+(-\S+)?$'; then
            echo "Invalid tag format: $TAG"
            echo "Expected format: v{major}.{minor}.{patch}[-{prerelease}]"
            exit 1
          fi
          echo "Valid tag: $TAG"
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Determine CircuitPython version from manifest
        id: cp_version
        run: |
          # Extract target OS version from manifest (e.g., "circuitpython_10" or "circuitpython_10_1")
          TARGET_OS=$(python -c "import json; manifest = json.load(open('src/manifest.json')); print(manifest['target_operating_systems'][0])")
          echo "target_os=$TARGET_OS" >> $GITHUB_OUTPUT
          
          # Parse major.minor from target OS (e.g., "circuitpython_10" -> "10", "circuitpython_9_3" -> "9.3")
          VERSION_PATTERN=$(echo "$TARGET_OS" | sed 's/circuitpython_//' | sed 's/_/./')
          echo "version_pattern=$VERSION_PATTERN" >> $GITHUB_OUTPUT
          echo "Looking for mpy-cross matching CircuitPython ${VERSION_PATTERN}.x"
          
          # Query S3 bucket for available mpy-cross versions
          S3_BUCKET_URL="https://adafruit-circuit-python.s3.amazonaws.com/?prefix=bin/mpy-cross/linux-amd64/&delimiter=/"
          
          # Fetch and parse available versions
          AVAILABLE_VERSIONS=$(curl -fsSL "$S3_BUCKET_URL" | \
            grep -o 'mpy-cross-linux-amd64-[0-9]\+\.[0-9]\+\.[0-9]\+\.static' | \
            sed 's/mpy-cross-linux-amd64-//' | \
            sed 's/\.static$//' | \
            sort -V)
          
          echo "Available versions:"
          echo "$AVAILABLE_VERSIONS"
          
          # Find the latest stable version matching our pattern
          # For "10" -> match "10.x.y"
          # For "9.3" -> match "9.3.y"
          MATCHING_VERSION=$(echo "$AVAILABLE_VERSIONS" | \
            grep "^${VERSION_PATTERN}\." | \
            tail -n 1)
          
          if [ -z "$MATCHING_VERSION" ]; then
            echo "Error: No matching mpy-cross version found for CircuitPython ${VERSION_PATTERN}.x"
            echo "Available versions:"
            echo "$AVAILABLE_VERSIONS"
            exit 1
          fi
          
          echo "cp_version=$MATCHING_VERSION" >> $GITHUB_OUTPUT
          echo "Selected mpy-cross version: $MATCHING_VERSION"
      
      - name: Download and setup mpy-cross
        run: |
          CP_VERSION="${{ steps.cp_version.outputs.cp_version }}"
          MPY_CROSS_URL="https://adafruit-circuit-python.s3.amazonaws.com/bin/mpy-cross/linux-amd64/mpy-cross-linux-amd64-${CP_VERSION}.static"
          
          echo "Downloading mpy-cross for CircuitPython ${CP_VERSION}..."
          curl -fsSL -o mpy-cross "${MPY_CROSS_URL}"
          
          # Verify download succeeded
          if [ ! -f mpy-cross ] || [ ! -s mpy-cross ]; then
            echo "Error: Failed to download mpy-cross"
            exit 1
          fi
          
          chmod +x mpy-cross
          
          # Verify version
          ./mpy-cross --version
          
          # Add to PATH for builder.py
          echo "${PWD}" >> $GITHUB_PATH
      
      - name: Build release package
        run: |
          # Use same builder.py logic as local builds (DRY)
          python builder.py --build
      
      - name: Verify build artifacts
        run: |
          if [ ! -f releases/wicid_install.zip ]; then
            echo "Error: Build artifact not found"
            exit 1
          fi
          echo "Build artifact verified: $(ls -lh releases/wicid_install.zip)"
      
      - name: Generate release notes
        run: |
          # Extract release_notes from src/manifest.json to RELEASE_NOTES.md
          python -c "import json; manifest = json.load(open('src/manifest.json')); open('RELEASE_NOTES.md', 'w').write(manifest.get('release_notes', 'No release notes provided.'))"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: releases/*.zip
          body_path: RELEASE_NOTES.md
          tag_name: ${{ github.ref_name }}
      
      - name: Sync releases.json to wicid_web
        uses: wadackel/files-sync-action@v3
        with:
          github_token: ${{ secrets.WICID_WEB_RELEASES_TOKEN }}
          config_file: .github/files-sync-config.yml

